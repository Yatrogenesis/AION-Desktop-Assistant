name: ğŸ§ª Automated Test Suite

on:
  push:
    branches: [ main, develop, add-release-workflow ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ğŸ¦€ Rust Tests
  rust-tests:
    name: ğŸ¦€ Rust Tests & Coverage
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy, rustfmt

    - name: ğŸ“¦ Cache Cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ” Cargo Check
      run: cargo check --manifest-path aion-server-rust/Cargo.toml --verbose

    - name: ğŸ§ª Run Unit Tests
      run: cargo test --manifest-path aion-server-rust/Cargo.toml --lib --verbose

    - name: ğŸ§ª Run Integration Tests
      run: cargo test --manifest-path aion-server-rust/Cargo.toml --test '*' --verbose

    - name: ğŸ¨ Check Formatting
      run: cargo fmt --manifest-path aion-server-rust/Cargo.toml --all -- --check

    - name: ğŸ“‹ Clippy Lints
      run: cargo clippy --manifest-path aion-server-rust/Cargo.toml --all-targets --all-features -- -D warnings

    - name: ğŸ“Š Coverage (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --manifest-path aion-server-rust/Cargo.toml --out Xml --output-dir ./coverage

    - name: ğŸ“¤ Upload Coverage
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/cobertura.xml
        flags: rust
        name: rust-coverage

  # ğŸ Python Tests
  python-tests:
    name: ğŸ Python Tests & Coverage
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements-test.txt

    - name: ğŸ§ª Run Tests with Coverage
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

    - name: ğŸ“¤ Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: python-${{ matrix.python-version }}
        name: python-${{ matrix.python-version }}-coverage

  # ğŸ” Code Quality
  code-quality:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Quality Tools
      run: |
        pip install black flake8 mypy pylint
        cargo install cargo-audit

    - name: ğŸ¨ Black Formatting Check
      run: black --check .

    - name: ğŸ” Flake8 Linting
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: ğŸ”’ Cargo Security Audit
      run: cargo audit --manifest-path aion-server-rust/Cargo.toml

    - name: ğŸ“‹ Dependency Check
      run: |
        cargo tree --manifest-path aion-server-rust/Cargo.toml | grep -i "duplicate" || true

  # ğŸš€ Performance Tests
  performance-tests:
    name: ğŸš€ Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: ğŸƒ Run Benchmarks
      run: |
        cargo build --manifest-path aion-server-rust/Cargo.toml --release
        echo "ğŸ“Š Binary Size:"
        ls -lh aion-server-rust/target/release/aion-server* | head -1

    - name: âš¡ Startup Time Test
      run: |
        timeout 5 aion-server-rust/target/release/aion-server &
        sleep 2
        curl http://localhost:8080/api/status || echo "Server startup check"

  # ğŸ“Š Test Summary
  test-summary:
    name: ğŸ“Š Test Summary
    needs: [rust-tests, python-tests, code-quality, performance-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ğŸ“¥ Check Results
      run: |
        echo "## ğŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Rust Tests: ${{ needs.rust-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Python Tests: ${{ needs.python-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Performance: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY

    - name: âŒ Fail if Tests Failed
      if: needs.rust-tests.result == 'failure' || needs.python-tests.result == 'failure'
      run: exit 1
