name: ğŸ¨ Emoji Linter

on:
  push:
    branches: [ main, develop, add-release-workflow ]
  pull_request:
    branches: [ main, develop ]

jobs:
  emoji-lint:
    name: ğŸ¨ Validate Emoji Standards
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ¨ Check Commit Message Emojis
      run: |
        echo "ğŸ” Validating commit message emojis..."

        VALID_EMOJIS="âœ¨|ğŸ›|ğŸ“|ğŸ”§|âš¡|â™»ï¸|ğŸš€|ğŸ”¥|ğŸ’š|ğŸ‘·|ğŸ“¦|â¬†ï¸|â¬‡ï¸|ğŸ”’|ğŸ¨|ğŸ¤–|ğŸ”„|ğŸš‘|ğŸ©¹|ğŸ“š|ğŸ’¡|ğŸ”¨|ğŸ“Œ|âœ…|ğŸ§ª|ğŸš¨|ğŸ§¹|ğŸšš|ğŸ”–|ğŸ“ˆ|ğŸ”—|ğŸ“¡|ğŸ”€|âª|ğŸš§|ğŸ—ï¸|ğŸ—ƒï¸|ğŸ’„|ğŸ”Š|ğŸ”‡|â™¿|ğŸŒ"

        for commit in $(git rev-list origin/${{ github.base_ref || 'main' }}..${{ github.sha }}); do
          MSG=$(git log -1 --pretty=%B $commit)
          FIRST_CHAR=$(echo "$MSG" | head -c 2)

          if ! echo "$MSG" | grep -qE "^($VALID_EMOJIS)"; then
            echo "âŒ Commit $commit does not start with a valid emoji!"
            echo "Message: $MSG"
            echo ""
            echo "See .github/COMMIT_CONVENTION.md for valid emojis"
            exit 1
          else
            echo "âœ… Commit $commit: Valid emoji"
          fi
        done

        echo "âœ… All commits follow emoji conventions!"

    - name: ğŸ¨ Check C# Files for Emoji Logging
      run: |
        echo "ğŸ” Checking C# files for emoji logging..."

        MISSING_EMOJIS=0

        find . -name "*.cs" -type f ! -path "*/bin/*" ! -path "*/obj/*" | while read file; do
          if grep -q "_logger\." "$file"; then
            if ! grep -qE "ğŸš€|âœ…|âŒ|âš ï¸|ğŸ”§|ğŸ“Š|ğŸ’¥|ğŸ—‘ï¸|ğŸ¯|ğŸ‘‚|ğŸ“|ğŸ”|ğŸ’¬|ğŸ¤|ğŸ”Š|ğŸ‘ï¸|ğŸ–±ï¸|âŒ¨ï¸|ğŸªŸ|â™¿|ğŸ¤–|ğŸ”„" "$file"; then
              echo "âš ï¸ $file has logging but no emojis"
              MISSING_EMOJIS=$((MISSING_EMOJIS + 1))
            fi
          fi
        done

        if [ $MISSING_EMOJIS -gt 0 ]; then
          echo "âš ï¸ Warning: $MISSING_EMOJIS files have logging without emojis"
          echo "Consider adding emojis for better log readability"
        else
          echo "âœ… All C# files with logging use emojis!"
        fi

    - name: ğŸ“ Check Markdown Files for Emojis
      run: |
        echo "ğŸ” Checking Markdown files for emojis..."

        MD_FILES=$(find . -name "*.md" ! -path "*/node_modules/*" ! -path "*/.git/*")

        for file in $MD_FILES; do
          if ! grep -qE "âœ¨|ğŸ“‹|ğŸš€|âœ…|ğŸ¯|ğŸ“¦|ğŸ”§|ğŸ’¡|ğŸ¤–|ğŸ”„|ğŸ“š" "$file"; then
            echo "ğŸ’¡ Suggestion: $file could benefit from emojis"
          else
            echo "âœ… $file uses emojis"
          fi
        done

    - name: ğŸ” Check README Badges
      run: |
        echo "ğŸ” Validating README badges..."

        if ! grep -q "!\[.*\](https://img.shields.io" README.md; then
          echo "âš ï¸ README.md missing badges"
        else
          echo "âœ… README.md has badges"
        fi

    - name: ğŸ“Š Generate Emoji Report
      run: |
        echo "ğŸ“Š Emoji Usage Report"
        echo "===================="
        echo ""

        echo "Commits by emoji:"
        git log --all --pretty=format:"%s" | grep -oE "^(âœ¨|ğŸ›|ğŸ“|ğŸ”§|âš¡|â™»ï¸|ğŸš€|ğŸ”¥|ğŸ’š|ğŸ‘·|ğŸ“¦|â¬†ï¸|â¬‡ï¸|ğŸ”’|ğŸ¨|ğŸ¤–|ğŸ”„)" | sort | uniq -c | sort -rn

        echo ""
        echo "Files with emoji logging:"
        find . -name "*.cs" -type f ! -path "*/bin/*" ! -path "*/obj/*" | while read file; do
          if grep -qE "ğŸš€|âœ…|âŒ|âš ï¸|ğŸ”§|ğŸ“Š|ğŸ’¥" "$file"; then
            echo "âœ… $(basename $file)"
          fi
        done | wc -l

    - name: âœ… Summary
      run: |
        echo "âœ… Emoji linting complete!"
        echo ""
        echo "Standards validated:"
        echo "- âœ… Commit message emojis"
        echo "- âœ… C# logging emojis"
        echo "- âœ… Markdown documentation emojis"
        echo "- âœ… README badges"
