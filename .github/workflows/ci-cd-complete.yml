name: ðŸš€ CI/CD Complete Pipeline

on:
  push:
    branches: [ main, develop, add-release-workflow ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_NAME: AionDesktopAssistant

jobs:
  # ðŸ§ª Testing
  test:
    name: ðŸ§ª Tests & Coverage
    runs-on: windows-latest

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore
      run: dotnet restore

    - name: ðŸ”¨ Build
      run: dotnet build --configuration Release --no-restore

    - name: ðŸ§ª Test
      run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --logger "trx"

    - name: ðŸ“Š Coverage
      uses: codecov/codecov-action@v3
      with:
        files: '**/coverage.cobertura.xml'
        fail_ci_if_error: false

    - name: ðŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/*.trx'

  # ðŸŽ¨ Quality
  quality:
    name: ðŸŽ¨ Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸŽ¨ Emoji Commit Check
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        if [[ ! $COMMIT_MSG =~ ^(âœ¨|ðŸ›|ðŸ“|ðŸ”§|âš¡|â™»ï¸|ðŸš€|ðŸ”¥|ðŸ’š|ðŸ‘·|ðŸ“¦|â¬†ï¸|â¬‡ï¸|ðŸ”’|ðŸŽ¨|ðŸ¤–|ðŸ”„) ]]; then
          echo "âš ï¸ Warning: Commit should start with an emoji"
        else
          echo "âœ… Commit follows emoji conventions"
        fi

    - name: ðŸ“Š Analyze .NET Code
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ” Code Analysis
      run: |
        dotnet restore
        dotnet build --configuration Release /p:EnableNETAnalyzers=true /p:AnalysisLevel=latest

  # ðŸ—ï¸ Build Multi-Platform
  build:
    name: ðŸ—ï¸ Build ${{ matrix.name }}
    needs: [test, quality]
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            name: Windows-x64
          - os: windows-latest
            runtime: win-arm64
            name: Windows-ARM64
          - os: ubuntu-latest
            runtime: linux-x64
            name: Linux-x64
          - os: macos-latest
            runtime: osx-x64
            name: macOS-x64
          - os: macos-latest
            runtime: osx-arm64
            name: macOS-ARM64

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Publish
      run: |
        dotnet publish --configuration Release \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish \
          /p:PublishSingleFile=true \
          /p:PublishTrimmed=true \
          /p:IncludeNativeLibrariesForSelfExtract=true

    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.name }}
        path: ./publish/*
        retention-days: 30

  # ðŸ“¦ Create Release
  release:
    name: ðŸš€ Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: ðŸ“¦ Create ZIP Packages
      run: |
        cd artifacts
        for dir in */; do
          zip -r "${dir%/}.zip" "$dir"
        done

    - name: ðŸ” Generate Checksums
      run: |
        cd artifacts
        sha256sum *.zip > checksums.txt

    - name: ðŸ“ Generate Release Notes
      id: notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        cat > notes.md << EOF
        ## ðŸŽ‰ AION Desktop Assistant $VERSION

        ### âœ¨ Features
        - ðŸ¤– Claude Code AI integration
        - ðŸ”„ Bidirectional control
        - ðŸŽ¤ Voice recognition & synthesis
        - ðŸ‘ï¸ OCR screen reading
        - ðŸ–±ï¸ Mouse & keyboard automation
        - â™¿ Accessibility-first design

        ### ðŸ“¦ Downloads
        **Windows:** x64, ARM64
        **Linux:** x64
        **macOS:** x64, ARM64 (Apple Silicon)

        ### ðŸš€ Quick Start
        1. Download for your platform
        2. Extract ZIP
        3. Run executable
        4. Configure voice settings
        5. Start using!

        ---
        ðŸš€ Generated with Claude Code
        EOF

    - name: ðŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ðŸŽ‰ ${{ github.ref_name }}
        body_path: notes.md
        files: |
          artifacts/*.zip
          artifacts/checksums.txt
        token: ${{ secrets.GITHUB_TOKEN }}

  # ðŸ“š Deploy Docs
  docs:
    name: ðŸ“š GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ”¨ Build Docs Site
      run: |
        mkdir -p docs-site
        cp *.md docs-site/
        cp version.json docs-site/

        cat > docs-site/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>ðŸ¤– AION Desktop Assistant</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
          <style>
            body { max-width: 980px; margin: 50px auto; padding: 20px; background: #0d1117; }
            .markdown-body { background: transparent; color: #c9d1d9; }
          </style>
        </head>
        <body class="markdown-body">
          <div id="content"></div>
          <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
          <script>
            fetch('README.md')
              .then(r => r.text())
              .then(t => document.getElementById('content').innerHTML = marked.parse(t));
          </script>
        </body>
        </html>
        EOF

    - name: ðŸš€ Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs-site
        cname: aion.yourdomain.com
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ðŸ“š docs: Deploy documentation'
